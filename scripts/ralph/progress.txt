# Ralph Progress Log
Started: 2026년 2월 21일 토요일 03시 32분 43초 KST

## Codebase Patterns
- SCENARIOS dict is in `web/services/linkedin_service.py` (module-level) - used by both service and API
- `web/api/linkedin.py` has regex validators for scenario parameter (e.g., `^[A-F]$`) - update when adding scenarios
- `detect_scenario()` uses keyword-based heuristics with priority ordering (first match wins)
- Always `python -m py_compile` after editing Python files
- ReferencePost model: `web/models/reference_post.py` - content, author, source_url, analysis fields
- Guidelines examples in markdown use pattern: `### 시나리오 X 예시` followed by code block
- Both LinkedInService and LinkedInAgent need parallel changes for prompt improvements
- detect_scenario() returns str, detect_scenario_detailed() returns dict with reason
- _scenario_cache (class var) caches Claude API results by article_id
---

## 2026-02-21 - LQ-009
- Added hot-reload: `self.guidelines = self._load_guidelines()` at start of generate_draft()
- Agent _step_guidelines_check() also reloads from file: `guidelines = self._load_guidelines() or guidelines`
- __init__ load preserved as initial value; generation-time reload ensures latest guidelines
- Files changed: web/services/linkedin_service.py, web/services/linkedin_agent.py
- **Learnings:** Simple one-line additions per file. Uses `or` fallback to keep existing guidelines if file read fails.
---

## 2026-02-21 - LQ-008
- Upgraded detect_scenario() to use Claude API (claude-haiku-4-5-20251001) with keyword fallback
- Added detect_scenario_detailed() returning {scenario, confidence, reason}
- detect_scenario() now delegates to detect_scenario_detailed() for backward compatibility
- In-memory cache (_scenario_cache) prevents duplicate API calls for same article_id
- web/app.py passes scenario_reason and scenario_confidence to template
- Template shows reason text below recommended scenario
- Files changed: web/services/linkedin_service.py, web/app.py, web/templates/articles/detail.html
- **Learnings for future iterations:**
  - Uses claude-haiku for cost efficiency in scenario detection
  - _scenario_cache is a class variable (shared across instances) - dict keyed by article.id
  - detect_scenario() still returns str for backward compat; detect_scenario_detailed() returns full dict
  - Template uses `{% if scenario_reason %}` guard for graceful display
---

## 2026-02-21 - LQ-007
- Added evaluation-driven retry in agent mode run() method
- After _step_evaluate(), parses JSON: checks overall_score < 70 or FAIL items >= 3
- Auto-generates fix prompt with FAIL items listed, regenerates, then re-evaluates (max 1 retry)
- SSE events: 'retry_start' and 'retry_complete' sent for frontend tracking
- Pre-retry and post-retry drafts both tracked
- Files changed: web/services/linkedin_agent.py
- **Learnings for future iterations:**
  - Evaluation JSON: {overall_score: int, items: [{category, rule, pass, comment}], summary: str}
  - Retry logic is in run() after _step_evaluate(), not inside _step_evaluate itself
  - _step_evaluate() can be called multiple times (original + retry)
---

## 2026-02-21 - LQ-006
- Replaced hardcoded 6-item review checklist with session.guidelines_checklist from Step 2
- User feedback now highlighted as "반드시 반영할 사항" with emphasis
- Prompt now says "다음 체크리스트의 모든 항목을 검증하고, 위반 사항을 반드시 수정하세요"
- Files changed: web/services/linkedin_agent.py
- **Learnings for future iterations:**
  - session.guidelines_checklist is created in _step_guidelines_check (Step 2) and stored in AgentSession
  - User feedback (session.user_feedback) only applied on first iteration (i == 0)
---

## 2026-02-21 - LQ-005
- Added `_validate_draft(content, article_url)` method to LinkedInService
- Validates: char count (1200-1800), forbidden words, emoji check, article URL presence
- `generate_draft()` now calls validation and auto-retries up to 2 times with fix prompt
- FORBIDDEN_WORDS class constant: 여러분, 혁명, 패러다임 시프트, 게임체인저, 하세요, 해보세요, 읽어주셔서 감사
- Emoji check uses `unicodedata.category` to detect Symbol_Other chars
- Files changed: web/services/linkedin_service.py
- **Learnings for future iterations:**
  - Emoji detection: `unicodedata.category(char).startswith("So")` covers most emoji symbols
  - Validation loop pattern: for attempt in range(max_retries), break on valid
  - Fix prompt includes current draft + specific issues for targeted correction
---

## 2026-02-21 - LQ-004
- Added `_build_article_context()` to both LinkedInService and LinkedInAgent
- Includes: category, score (with tone guide), viral_score (with context), authority source detection
- Score >= 8: "깊은 분석" guide, Score <= 5: "간결한 코멘터리" guide
- Authority sources: MIT, Stanford, Google, DeepMind, OpenAI, Anthropic, Meta AI, Microsoft Research
- Applied in simple mode (_build_prompt) and agent mode (_step_analyze, _step_draft)
- Files changed: web/services/linkedin_service.py, web/services/linkedin_agent.py
- **Learnings for future iterations:**
  - Article model fields: score (Float), viral_score (Float, nullable), category (String), source (String)
  - _build_article_context() is a shared pattern now used by both service and agent
---

## 2026-02-21 - LQ-003
- Added `_get_reference_examples(scenario)` to both LinkedInService and LinkedInAgent
- DB reference posts (max 2) + guidelines example extraction via regex
- Included as "참고 예시" section in prompts for both simple and agent mode
- Files changed: web/services/linkedin_service.py, web/services/linkedin_agent.py
- **Learnings for future iterations:**
  - ReferencePost has no scenario column - currently gets most recent posts regardless of scenario
  - Guidelines examples use `### 시나리오 X 예시` + code blocks - regex pattern extracts content between ```
  - Changes to prompt building in linkedin_service.py usually need mirror changes in linkedin_agent.py
---

## 2026-02-21 - LQ-002
- Integrated self.guidelines into _build_prompt() with conditional logic
- When guidelines file exists: full guidelines text included as "작성 지침서" section
- When guidelines empty: fallback to existing hardcoded rules (문체, 금지사항, 구조, 길이)
- Prompt structure: 페르소나 → 시나리오 → 기사 정보 → 지침서/규칙 → 출력 형식
- Files changed: web/services/linkedin_service.py
- **Learnings for future iterations:**
  - _build_prompt() uses f-string with conditional sections built as variables
  - self.guidelines loaded from LINKEDIN_GUIDELINES_PATH (data/linkedin_guidelines.md)
  - The hardcoded rules are a minimal fallback; the full guidelines file is much more comprehensive
---

## 2026-02-21 - LQ-001
- Added Scenario F (권위자 관점 + 역설적 인사이트) to SCENARIOS dict with all required fields
- Added Scenario F detection keywords to detect_scenario(): 권위자, expert, 통념, 학습, fomo, 배워야, 역설, misconception, myth, contrary
- Updated regex in web/api/linkedin.py from ^[A-E]$ to ^[A-F]$ (both generate and agent endpoints)
- Updated docstrings to reflect A-F range
- Files changed: web/services/linkedin_service.py, web/api/linkedin.py
- **Learnings for future iterations:**
  - The regex `^[A-E]$` appears in TWO places in linkedin.py (generate_draft and agent_start) - use replace_all
  - detect_scenario() has priority ordering: more specific keywords first, Scenario F keywords last since they're broader
  - SCENARIOS dict fields: name, description, hook_style, structure, closing
---
