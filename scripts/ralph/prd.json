{
  "project": "AI Daily Digest",
  "branchName": "ralph/linkedin-quality-boost",
  "description": "LinkedIn 좋은 글 쓰기 V2: 가이드라인 실제 반영, 레퍼런스 활용, 품질 검증, 반복 개선(채팅+편집), 훅 랩. V2-001~005는 이전 작업에서 구현 완료.",
  "userStories": [
    {
      "id": "V2-001",
      "title": "Fix guidelines integration and import json bug",
      "description": "_build_prompt()에 self.guidelines가 로드되지만 프롬프트에 포함되지 않는 치명적 버그 수정. 또한 import json 누락으로 chat_refine_by_draft()가 crash하는 버그도 수정.",
      "acceptanceCriteria": [
        "web/services/linkedin_service.py 상단에 import json 추가",
        "_build_prompt()에서 self.guidelines가 있으면 프롬프트에 '## LinkedIn 포스팅 지침서' 섹션으로 전문 포함",
        "self.guidelines가 비어있으면 기존 하드코딩된 '## 공통 규칙' 섹션을 폴백으로 사용",
        "프롬프트 구조 순서: 페르소나 → 시나리오 → 기사 정보 → 지침서(또는 폴백 규칙) → 출력 형식",
        "generate_draft()에서 self.guidelines = self._load_guidelines() 호출하여 매번 최신 지침서 반영 (hot-reload)",
        "python -m py_compile web/services/linkedin_service.py 통과"
      ],
      "priority": 1,
      "passes": true,
      "notes": "이전 LQ 시리즈에서 구현 완료. import json, guidelines in prompt, hot-reload 모두 반영됨."
    },
    {
      "id": "V2-002",
      "title": "Add Scenario F and reference posts as few-shot examples",
      "description": "지침서에 정의된 시나리오 F를 코드에 추가하고, 레퍼런스 포스트를 프롬프트에 few-shot 예시로 포함한다.",
      "acceptanceCriteria": [
        "SCENARIOS 딕셔너리에 F 추가",
        "detect_scenario()에 시나리오 F 감지 키워드 추가",
        "web/api/linkedin.py의 scenario regex를 ^[A-F]$로 변경",
        "LinkedInService에 _get_reference_examples(scenario) 메서드 추가",
        "_build_prompt()에 참고 예시 섹션 추가",
        "python -m py_compile 통과"
      ],
      "priority": 2,
      "passes": true,
      "notes": "이전 LQ 시리즈에서 구현 완료. Scenario F, _get_reference_examples(), regex ^[A-F]$ 모두 반영됨."
    },
    {
      "id": "V2-003",
      "title": "Enrich article context and score-based tone guidance",
      "description": "프롬프트에 기사의 score, viral_score, category, source 등 메타데이터를 추가하고, 점수 기반 톤 가이드를 제공한다.",
      "acceptanceCriteria": [
        "_build_prompt()에 article context 메타데이터 포함",
        "score 기반 톤 가이드 추가",
        "viral_score, source 기반 맥락 추가",
        "agent 모드에도 동일 적용",
        "python -m py_compile 통과"
      ],
      "priority": 3,
      "passes": true,
      "notes": "이전 LQ 시리즈에서 구현 완료. _build_article_context() 메서드로 분리되어 simple/agent 양쪽에서 사용."
    },
    {
      "id": "V2-004",
      "title": "Post-generation quality validation with auto-retry",
      "description": "생성된 포스트의 글자수, 금지어, 이모지, 원문 링크를 자동 검증하고, 실패 시 자동 재생성한다.",
      "acceptanceCriteria": [
        "_validate_draft() 메서드 추가",
        "generate_draft()에서 검증 후 자동 재생성",
        "python -m py_compile 통과"
      ],
      "priority": 4,
      "passes": true,
      "notes": "이전 LQ 시리즈에서 구현 완료. _validate_draft() + 최대 2회 재생성 로직 반영됨."
    },
    {
      "id": "V2-005",
      "title": "Agent mode: real checklist review + evaluation-driven retry",
      "description": "Agent 모드의 검토/평가 단계 품질 향상.",
      "acceptanceCriteria": [
        "_step_review()에서 하드코딩 검토 항목 제거, guidelines_checklist 활용",
        "_step_evaluate() 후 자동 재시도 로직",
        "retry_start/retry_complete SSE 이벤트",
        "python -m py_compile 통과"
      ],
      "priority": 5,
      "passes": true,
      "notes": "이전 LQ 시리즈에서 구현 완료. 하드코딩 제거, overall_score < 70 || FAIL >= 3 재시도, SSE 이벤트 반영됨."
    },
    {
      "id": "V2-006",
      "title": "Draft-based chat: guidelines_checklist column + draft chat endpoint",
      "description": "페이지 새로고침 후에도 채팅이 작동하도록 draft 기반 채팅 인프라를 완성한다. 현재 session-based chat만 있고, 세션 소멸 시 채팅 불가. chat_refine_by_draft()는 이미 존재하지만 guidelines_checklist 컬럼 누락과 API 엔드포인트 부재로 동작 불가.",
      "acceptanceCriteria": [
        "LinkedInDraft 모델에 guidelines_checklist 컬럼(Text, nullable) 추가",
        "LinkedInDraft.to_dict()에 guidelines_checklist 포함",
        "web/database.py migrate_db()에 guidelines_checklist ALTER TABLE 추가",
        "linkedin_agent.py의 _save_draft()에서 session.guidelines_checklist를 draft.guidelines_checklist에 저장",
        "web/api/linkedin.py에 POST /api/linkedin/drafts/{draft_id}/chat 엔드포인트 추가: ChatMessage body → service.chat_refine_by_draft() 호출 → 결과 반환",
        "chat_refine_by_draft()가 draft.guidelines_checklist를 정상적으로 읽을 수 있는지 확인",
        "python -m py_compile web/models/linkedin_draft.py web/database.py web/api/linkedin.py web/services/linkedin_agent.py 통과"
      ],
      "priority": 6,
      "passes": true,
      "notes": "구현 완료: guidelines_checklist 컬럼+마이그레이션+to_dict(), _save_draft()에서 저장, chat_refine_by_draft() 메서드, POST /drafts/{draft_id}/chat 엔드포인트."
    },
    {
      "id": "V2-007",
      "title": "Draft-based chat frontend + existing draft card chat/edit UI",
      "description": "현재 채팅/편집 UI는 agent-result-panel(session 기반)에만 있다. 기존 초안 카드(drafts-container)에서도 채팅과 편집이 가능하도록 draft-based 채팅 UI를 추가한다.",
      "acceptanceCriteria": [
        "drafts-container의 각 초안 카드에 '채팅' 버튼 추가 — 클릭 시 해당 초안 하단에 채팅 UI 토글",
        "채팅 전송 시 POST /api/linkedin/drafts/{draft_id}/chat 호출 (session 아닌 draft 기반)",
        "응답에서 updated_content가 있으면 초안 텍스트 + 글자수 배지 업데이트",
        "기존 초안 카드에도 '편집' 버튼 추가 (현재 agent-result-panel에만 있음)",
        "편집 저장 시 PATCH /api/linkedin/drafts/{draft_id}/content 호출",
        "agent-result-panel의 세션 기반 채팅이 끊긴 후(새로고침) draft 기반으로 전환",
        "페이지 로드 시 기존 chat_history가 있는 초안은 채팅 이력 렌더링"
      ],
      "priority": 7,
      "passes": true,
      "notes": "구현 완료: 초안 카드에 편집/채팅 버튼 + 인라인 편집 패널(startDraftEdit/saveDraftEdit) + 드래프트 기반 채팅 패널(toggleDraftChat/sendDraftChat) + 글자수 배지 + 기존 chat_history 렌더링 + agent chat → draft chat 폴백."
    },
    {
      "id": "V2-008",
      "title": "Hook Lab: generate multiple hooks before full draft",
      "description": "LinkedIn 포스트에서 훅(첫 1-3줄)이 가장 중요하다. 풀 초안 생성 전에 3-5개 훅 옵션을 먼저 보여주고, 사용자가 선택한 훅으로 초안을 생성한다.",
      "acceptanceCriteria": [
        "web/services/linkedin_service.py에 generate_hooks(article, scenario, count=5) 메서드 추가",
        "Claude API로 기사+시나리오+가이드라인에 맞는 훅 5개 생성 — 각 훅은 1-3줄, 다른 접근법/스타일",
        "반환: list[dict] — 각 {hook: str, style: str(숫자형/질문형/역설/선언/스토리), reasoning: str(왜 이 훅이 효과적인지)}",
        "web/api/linkedin.py에 POST /api/linkedin/hooks/{article_id}?scenario=A 엔드포인트 추가",
        "detail.html에 '훅 먼저 고르기' 버튼 추가 (시나리오 선택 후, 생성 전 위치)",
        "클릭 시 훅 옵션을 카드 형태로 표시 — 각 카드: 훅 텍스트 + 스타일 배지 + LinkedIn 미리보기(renderLinkedInPreview 활용)",
        "사용자가 훅 카드 클릭 시 선택 표시 → '이 훅으로 초안 생성' 버튼 활성화",
        "generate_draft()에 hook 파라미터(Optional[str]) 추가 — 있으면 프롬프트에 '## 사용할 훅' 섹션으로 포함하여 이 훅으로 시작하도록 지시",
        "agent_start에도 hook Query 파라미터 추가, _step_draft()에서 hook 전달",
        "python -m py_compile web/services/linkedin_service.py web/api/linkedin.py 통과"
      ],
      "priority": 8,
      "passes": false,
      "notes": "LinkedIn '더보기' 접힘점: 약 210자 또는 줄바꿈 3번째. renderLinkedInPreview() 함수가 이미 detail.html에 있으므로 훅 미리보기에 재활용. 훅 스타일 분류는 가이드라인의 시나리오별 hook_style 참고."
    }
  ]
}
