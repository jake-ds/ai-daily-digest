{
  "project": "AI Daily Digest",
  "branchName": "ralph/linkedin-quality-boost",
  "description": "LinkedIn 포스팅 생성 품질 대폭 강화: 지침서 통합, 레퍼런스 활용, 시나리오 F 추가, 품질 게이트, 평가 기반 자동 재생성",
  "userStories": [
    {
      "id": "LQ-001",
      "title": "Add Scenario F and fix SCENARIOS dict",
      "description": "지침서에 정의된 시나리오 F(권위자 관점 + 역설적 인사이트)를 코드에 추가하고, detect_scenario()에도 반영한다.",
      "acceptanceCriteria": [
        "web/services/linkedin_service.py의 SCENARIOS 딕셔너리에 F 추가 (name, description, hook_style, structure, closing - data/linkedin_guidelines.md의 시나리오 F 섹션 참고)",
        "detect_scenario()에 시나리오 F 감지 키워드 추가 (권위자, expert, 통념, 학습, FOMO 등)",
        "web/api/linkedin.py의 scenario Query 정규식을 ^[A-F]$로 변경",
        "python -m py_compile web/services/linkedin_service.py web/api/linkedin.py 통과"
      ],
      "priority": 1,
      "passes": true,
      "notes": "data/linkedin_guidelines.md에 시나리오 F가 이미 정의되어 있음. 코드에만 누락된 상태"
    },
    {
      "id": "LQ-002",
      "title": "Integrate full guidelines into simple mode prompt",
      "description": "linkedin_service.py의 _build_prompt()에서 self.guidelines를 실제로 프롬프트에 포함시킨다. 현재 로드만 하고 사용하지 않는 치명적 버그 수정.",
      "acceptanceCriteria": [
        "_build_prompt()의 프롬프트 텍스트에 self.guidelines 전문을 포함하는 섹션 추가",
        "guidelines가 비어있으면 기존 하드코딩된 규칙을 폴백으로 사용",
        "프롬프트 구조: 페르소나 → 시나리오 → 기사 정보 → 지침서(guidelines) → 공통 규칙 → 출력 형식",
        "기존 하드코딩된 공통 규칙 섹션은 guidelines가 없을 때만 사용하도록 분기",
        "python -m py_compile 통과"
      ],
      "priority": 2,
      "passes": true,
      "notes": "self.guidelines는 __init__에서 이미 로드됨 (line 64). _build_prompt()에서 사용만 하면 됨"
    },
    {
      "id": "LQ-003",
      "title": "Add reference posts as few-shot examples in prompts",
      "description": "생성 시 해당 시나리오의 레퍼런스 포스팅과 지침서 예시를 few-shot 예시로 프롬프트에 포함한다.",
      "acceptanceCriteria": [
        "LinkedInService에 _get_reference_examples(scenario) 메서드 추가: DB에서 ReferencePost 최대 2개 + 지침서의 해당 시나리오 예시 추출",
        "_build_prompt()에서 _get_reference_examples() 호출하여 '참고 예시' 섹션으로 프롬프트에 포함",
        "예시는 '다음은 좋은 포스팅 예시입니다. 이 스타일과 구조를 참고하세요:' 형태로 포함",
        "레퍼런스가 없으면 지침서 예시만, 지침서 예시도 없으면 섹션 생략",
        "LinkedInAgent의 _step_draft()에도 동일하게 레퍼런스 예시 포함",
        "python -m py_compile 통과"
      ],
      "priority": 3,
      "passes": false,
      "notes": "ReferencePost 모델은 web/models/reference_post.py에 있음. from web.models import ReferencePost로 import"
    },
    {
      "id": "LQ-004",
      "title": "Enrich article context in generation prompts",
      "description": "프롬프트에 기사의 score, viral_score, category, source 등 풍부한 맥락을 추가하여 더 깊은 분석이 가능하게 한다.",
      "acceptanceCriteria": [
        "_build_prompt()에 기사 메타데이터 섹션 추가: category, score, viral_score, source",
        "score 기반 톤 가이드 추가: 8+ 고품질 → 깊은 분석 권장, 5 이하 → 간결한 코멘터리 권장",
        "viral_score 있으면 '화제성 높은 뉴스' 맥락 추가",
        "source 기반 맥락: 'MIT/Stanford/Google 등 → 연구 권위 강조' 가이드",
        "LinkedInAgent의 _step_analyze()와 _step_draft()에도 동일하게 반영",
        "python -m py_compile 통과"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Article 모델에 score, viral_score, category, source 필드 모두 존재"
    },
    {
      "id": "LQ-005",
      "title": "Add post-generation quality validation",
      "description": "생성된 포스트의 글자수, 금지어 포함 여부, 원문 링크 유무를 자동 검증하는 유틸리티를 만들고, 검증 실패 시 자동 재생성한다.",
      "acceptanceCriteria": [
        "web/services/linkedin_service.py에 _validate_draft(content, article_url) 메서드 추가",
        "검증 항목: (1) 글자수 1200-1800 범위 (2) 금지어 체크 (이모지, 여러분, 혁명, 패러다임 시프트, 게임체인저, ~하세요, ~해보세요, 읽어주셔서 감사) (3) 원문 링크 포함 여부",
        "검증 결과를 dict로 반환: {valid: bool, issues: list[str], char_count: int}",
        "generate_draft()에서 _validate_draft() 호출, 실패 시 이슈를 포함한 수정 프롬프트로 1회 재생성",
        "최대 재생성 횟수 2회 (무한 루프 방지)",
        "python -m py_compile 통과"
      ],
      "priority": 5,
      "passes": false,
      "notes": "금지어 목록은 data/linkedin_guidelines.md의 '금지 사항' 섹션 참고"
    },
    {
      "id": "LQ-006",
      "title": "Improve agent mode review step with guidelines-based checklist",
      "description": "Agent 모드 Step 4(자기 검토)에서 하드코딩된 6개 항목 대신 Step 2에서 생성한 가이드라인 체크리스트를 실제로 활용한다.",
      "acceptanceCriteria": [
        "linkedin_agent.py의 _step_review()에서 session.guidelines_checklist를 프롬프트에 포함",
        "하드코딩된 '검토 항목 1-6' 제거, 대신 '다음 체크리스트의 모든 항목을 검증하고, 위반 사항을 반드시 수정하세요' 형태로 변경",
        "사용자 피드백(session.user_feedback)도 '반드시 반영할 사항'으로 강조",
        "python -m py_compile 통과"
      ],
      "priority": 6,
      "passes": false,
      "notes": "session.guidelines_checklist는 Step 2에서 생성됨"
    },
    {
      "id": "LQ-007",
      "title": "Add evaluation-driven retry in agent mode",
      "description": "Agent 모드 Step 5(평가) 결과가 70점 미만이거나 FAIL 항목이 3개 이상이면, 자동으로 수정 루프를 돌린다.",
      "acceptanceCriteria": [
        "_step_evaluate() 후 overall_score < 70 또는 FAIL 항목 >= 3이면 자동 수정 진행",
        "수정 프롬프트: 평가 결과의 FAIL 항목을 명시하고 해당 부분만 수정 요청",
        "수정 후 재평가 (최대 1회 추가 루프, 무한 방지)",
        "SSE 이벤트로 'retry_start', 'retry_complete' 전송하여 프론트에서 진행 상태 표시",
        "최종 결과(수정 전/후)를 모두 draft에 저장",
        "python -m py_compile 통과"
      ],
      "priority": 7,
      "passes": false,
      "notes": "evaluation JSON 구조: {overall_score: int, items: [{pass: bool, ...}]}"
    },
    {
      "id": "LQ-008",
      "title": "Upgrade scenario detection to Claude-based analysis",
      "description": "detect_scenario()를 단순 키워드 매칭에서 Claude API 기반 분석으로 업그레이드한다.",
      "acceptanceCriteria": [
        "detect_scenario()에서 Claude API를 호출하여 기사 제목+요약을 분석, 최적 시나리오(A-F) + 근거를 반환",
        "반환 형태: {scenario: str, confidence: float, reason: str}",
        "API 호출 실패 시 기존 키워드 기반 로직으로 폴백",
        "결과를 캐싱하여 같은 article_id에 대해 중복 호출 방지 (Article 모델에 detected_scenario 컬럼 추가 또는 인메모리 캐시)",
        "web/app.py의 article_detail에서 reason도 템플릿에 전달",
        "web/templates/articles/detail.html에서 추천 시나리오 옆에 근거 표시",
        "python -m py_compile 통과"
      ],
      "priority": 8,
      "passes": false,
      "notes": "비용 고려: claude-haiku 사용 권장. 시나리오 선택 가이드는 data/linkedin_guidelines.md 하단에 있음"
    },
    {
      "id": "LQ-009",
      "title": "Add guidelines hot-reload on each generation",
      "description": "LinkedInService와 LinkedInAgent가 매 생성 시 지침서 파일을 새로 로드하여, 지침 학습 결과가 즉시 반영되도록 한다.",
      "acceptanceCriteria": [
        "LinkedInService.generate_draft()에서 self.guidelines = self._load_guidelines() 재호출",
        "LinkedInAgent._step_guidelines_check()에서도 매번 파일에서 새로 로드",
        "__init__에서의 로드는 유지 (초기값), 생성 시점에 refresh",
        "python -m py_compile 통과"
      ],
      "priority": 9,
      "passes": false,
      "notes": "간단한 변경이지만, 지침 학습 시스템과의 연결고리로 중요"
    },
    {
      "id": "LQ-010",
      "title": "Enhance prompt formatting and length enforcement",
      "description": "프롬프트에 LinkedIn 포맷팅 규칙과 강력한 길이 제약을 추가한다.",
      "acceptanceCriteria": [
        "프롬프트에 LinkedIn 포맷팅 가이드 추가: 줄바꿈으로 단락 구분, 짧은 문장, 넘버링 활용, 구분선(ㅡ) 활용",
        "길이 제약 강화: '반드시 1200자 이상 1800자 이하로 작성. 이상적 길이는 1400-1600자. 이 범위를 벗어나면 조절하세요'",
        "출력 형식 명시: '제목/헤더 없이 본문만 출력. 첫 줄이 곧 훅. 마지막에 원문 링크 한 줄'",
        "anti-pattern 명시: '다음과 같이 작성하지 마세요: (1) 너무 일반적인 서론 (2) ~에 대해 이야기하겠습니다 (3) 결론적으로~ (4) 요약하면~'",
        "simple 모드와 agent 모드 양쪽에 적용",
        "python -m py_compile 통과"
      ],
      "priority": 10,
      "passes": false,
      "notes": "data/linkedin_guidelines.md의 공통 규칙, 권장 사항 섹션 참고"
    }
  ]
}
