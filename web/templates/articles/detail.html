{% extends "base.html" %}

{% block title %}{{ article.title }} - AI Daily Digest{% endblock %}

{% block head %}
<style>
    /* Agent timeline styles */
    .agent-step {
        border-left: 3px solid #e5e7eb;
        transition: border-color 0.3s;
    }
    .agent-step.active { border-color: #3b82f6; }
    .agent-step.completed { border-color: #22c55e; }
    .agent-step.waiting { border-color: #f59e0b; }
    .agent-step.error { border-color: #ef4444; }

    .step-indicator {
        width: 28px; height: 28px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: 600;
        position: relative; left: -16px;
        flex-shrink: 0;
    }
    .step-indicator.pending { background: #f3f4f6; color: #9ca3af; }
    .step-indicator.active { background: #3b82f6; color: white; }
    .step-indicator.completed { background: #22c55e; color: white; }
    .step-indicator.waiting { background: #f59e0b; color: white; }
    .step-indicator.error { background: #ef4444; color: white; }

    .step-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    .step-content.expanded {
        max-height: 5000px;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    .pulse-dot { animation: pulse-dot 1.5s infinite; }

    /* Evaluation table styles */
    .eval-pass { color: #16a34a; }
    .eval-fail { color: #dc2626; }

    /* Reference data toggle */
    .ref-data-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    .ref-data-content.expanded {
        max-height: 10000px;
    }

    /* Chat messages */
    .chat-msg-user {
        background: #ede9fe;
        border-radius: 12px 12px 0 12px;
        margin-left: auto;
        max-width: 80%;
    }
    .chat-msg-assistant {
        background: #f3f4f6;
        border-radius: 12px 12px 12px 0;
        max-width: 80%;
    }

    /* Char counter colors */
    .char-danger { color: #dc2626; }
    .char-warning { color: #d97706; }
    .char-ideal { color: #16a34a; }

    /* Hook Lab styles */
    .hook-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .hook-card:hover {
        border-color: #f59e0b;
        background: #fffbeb;
    }
    .hook-card.selected {
        border-color: #f59e0b;
        background: #fef3c7;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .hook-preview {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        color: #1a1a1a;
    }
    .hook-preview .fold-indicator {
        color: #6b7280;
        font-size: 13px;
    }
    .hook-style-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 600;
    }

    /* Scorecard styles */
    .scorecard-score-circle {
        width: 72px; height: 72px;
        border-radius: 50%;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        font-weight: 700;
    }
    .scorecard-score-circle .score-number { font-size: 28px; line-height: 1; }
    .scorecard-score-circle .score-label { font-size: 10px; opacity: 0.8; }
    .scorecard-score-circle.score-green { background: #dcfce7; color: #15803d; }
    .scorecard-score-circle.score-yellow { background: #fef9c3; color: #a16207; }
    .scorecard-score-circle.score-red { background: #fee2e2; color: #b91c1c; }
    .scorecard-category { border-left: 3px solid #e5e7eb; padding-left: 12px; }
    .scorecard-category.cat-pass { border-color: #22c55e; }
    .scorecard-category.cat-fail { border-color: #ef4444; }
    .scorecard-category.cat-mixed { border-color: #f59e0b; }
    .scorecard-item-pass { color: #16a34a; }
    .scorecard-item-fail { color: #dc2626; }

    /* Compare panel styles */
    .compare-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .compare-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        background: white;
    }
    .compare-card.selected-final {
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
    }
    .compare-hook {
        background: #fef3c7;
        border-radius: 6px;
        padding: 8px 12px;
        font-weight: 600;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .compare-bar {
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .compare-checkbox {
        position: absolute;
        top: 8px;
        right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back link -->
    <a href="/articles" class="inline-flex items-center text-gray-600 hover:text-gray-900">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Articles
    </a>

    <!-- Article Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center space-x-2">
                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded">
                    {{ article.category or 'unknown' }}
                </span>
                <span class="px-2 py-1 text-xs font-bold bg-blue-100 text-blue-800 rounded">
                    Score: {{ "%.1f"|format(article.score) }}
                </span>
                {% if article.viral_score %}
                <span class="px-2 py-1 text-xs font-bold bg-orange-100 text-orange-800 rounded">
                    Viral: {{ "%.1f"|format(article.viral_score) }}
                </span>
                {% endif %}
            </div>
            <div class="flex items-center gap-3">
                <!-- Favorite Button -->
                <button id="favorite-btn"
                        onclick="toggleFavorite()"
                        class="text-2xl hover:scale-110 transition"
                        data-favorite="{{ 'true' if article.is_favorite else 'false' }}">
                    {% if article.is_favorite %}
                    <span class="text-yellow-500">&#9733;</span>
                    {% else %}
                    <span class="text-gray-300 hover:text-yellow-400">&#9734;</span>
                    {% endif %}
                </button>
                <span class="text-sm text-gray-500">
                    {{ article.collected_at.strftime('%Y-%m-%d %H:%M') if article.collected_at else '' }}
                </span>
            </div>
        </div>

        <h1 class="text-2xl font-bold text-gray-900 mb-4">{{ article.title }}</h1>

        <div class="flex items-center space-x-4 text-sm text-gray-600 mb-6">
            <span>Source: <strong>{{ article.source }}</strong></span>
            {% if article.published_at %}
            <span>Published: {{ article.published_at.strftime('%Y-%m-%d') }}</span>
            {% endif %}
        </div>

        <a href="{{ article.url }}" target="_blank" rel="noopener"
           class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Read Original Article
        </a>
    </div>

    <!-- Summary -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Summary</h2>
        {% if article.ai_summary %}
        <div class="p-4 bg-blue-50 rounded-lg mb-4">
            <div class="text-xs font-medium text-blue-600 mb-2">AI Summary</div>
            <p class="text-gray-800">{{ article.ai_summary }}</p>
        </div>
        {% endif %}

        {% if article.summary %}
        <div class="p-4 bg-gray-50 rounded-lg">
            <div class="text-xs font-medium text-gray-600 mb-2">Original Summary</div>
            <p class="text-gray-700">{{ article.summary }}</p>
        </div>
        {% endif %}

        {% if not article.ai_summary and not article.summary %}
        <p class="text-gray-500">No summary available.</p>
        {% endif %}
    </div>

    <!-- LinkedIn Section -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">LinkedIn Posting</h2>

        <!-- Recommended Scenario -->
        <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-start">
                <span class="text-2xl mr-3">&#x1F4A1;</span>
                <div class="flex-1">
                    <div class="font-medium text-blue-900 flex items-center gap-2">
                        추천 시나리오: {{ recommended_scenario }} - {{ scenarios[recommended_scenario].name }}
                        {% set conf_pct = (scenario_confidence * 100) | int %}
                        <span class="text-xs px-2 py-0.5 rounded-full font-medium
                            {% if conf_pct >= 80 %}bg-green-100 text-green-700
                            {% elif conf_pct >= 60 %}bg-yellow-100 text-yellow-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ conf_pct }}%
                        </span>
                    </div>
                    {% if scenario_reason %}
                    <div class="text-sm text-blue-700 mt-1">{{ scenario_reason }}</div>
                    {% endif %}
                    <div class="text-sm text-blue-600 mt-1">{{ scenarios[recommended_scenario].description }}</div>
                </div>
            </div>
        </div>

        <!-- Alternative Scenario (confidence < 0.75) -->
        {% if scenario_confidence < 0.75 and scenario_alternatives %}
        <div id="alternative-scenario-section" class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
            <div class="text-sm font-medium text-amber-800 mb-2">대안 시나리오</div>
            {% for alt in scenario_alternatives %}
            <button type="button"
                onclick="selectScenario('{{ alt.scenario }}')"
                class="w-full text-left p-2 rounded-lg border border-amber-200 bg-white hover:bg-amber-50 transition group">
                <div class="flex items-center gap-2">
                    <span class="font-medium text-gray-900">{{ alt.scenario }}: {{ scenarios[alt.scenario].name }}</span>
                    {% set alt_pct = (alt.confidence * 100) | int %}
                    <span class="text-xs px-2 py-0.5 rounded-full font-medium
                        {% if alt_pct >= 80 %}bg-green-100 text-green-700
                        {% elif alt_pct >= 60 %}bg-yellow-100 text-yellow-700
                        {% else %}bg-red-100 text-red-700{% endif %}">
                        {{ alt_pct }}%
                    </span>
                </div>
                {% if alt.reason %}
                <div class="text-xs text-gray-600 mt-1">{{ alt.reason }}</div>
                {% endif %}
            </button>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Scenario Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">시나리오 선택</label>
            <div class="flex flex-wrap gap-2 mb-3">
                {% for key, scenario in scenarios.items() %}
                <button type="button"
                    onclick="selectScenario('{{ key }}')"
                    id="scenario-btn-{{ key }}"
                    class="px-3 py-2 rounded-lg border-2 transition-all text-sm
                        {% if key == recommended_scenario %}
                        border-blue-500 bg-blue-50 text-blue-700
                        {% else %}
                        border-gray-200 bg-white text-gray-700 hover:border-gray-300
                        {% endif %}"
                >
                    <span class="font-medium">{{ key }}</span>
                    <span class="hidden sm:inline">: {{ scenario.name }}</span>
                    {% if key == recommended_scenario %}
                    <span class="ml-1 text-xs bg-blue-500 text-white px-1.5 py-0.5 rounded">추천</span>
                    {% set conf_pct = (scenario_confidence * 100) | int %}
                    <span class="ml-1 text-xs px-1.5 py-0.5 rounded
                        {% if conf_pct >= 80 %}bg-green-100 text-green-700
                        {% elif conf_pct >= 60 %}bg-yellow-100 text-yellow-700
                        {% else %}bg-red-100 text-red-700{% endif %}">{{ conf_pct }}%</span>
                    {% endif %}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" id="scenario-select" value="{{ recommended_scenario }}">
            <p id="scenario-description" class="text-sm text-gray-600">
                {{ scenarios[recommended_scenario].description }}
            </p>
        </div>

        <!-- Generation Buttons -->
        <div class="flex flex-wrap gap-3 mb-4">
            <!-- Hook Lab -->
            <button
                id="hook-lab-btn"
                onclick="startHookLab()"
                class="inline-flex items-center px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition disabled:opacity-50"
            >
                <span id="hook-lab-spinner" class="hidden">
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Hook Lab
            </button>

            <!-- Simple Generate -->
            <button
                id="generate-btn"
                onclick="generateWithHook()"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50"
            >
                <span id="generate-spinner" class="hidden">
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Generate Draft
            </button>

            <!-- Agent Mode -->
            <button
                id="agent-btn"
                onclick="showAgentInstructionsPanel()"
                class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50"
            >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                Agent Mode
            </button>
        </div>

        <!-- Hook Lab Panel (hidden by default) -->
        <div id="hook-lab-panel" class="hidden mb-6">
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-amber-50 px-4 py-3 border-b flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-amber-700 font-semibold">Hook Lab</span>
                        <span class="ml-2 text-sm text-amber-600">훅을 먼저 선택하고, 그 훅으로 초안을 생성합니다</span>
                    </div>
                    <button onclick="closeHookLab()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Hook Cards -->
                <div id="hook-cards" class="p-4 space-y-3">
                    <div class="text-center text-gray-500 py-4">훅 생성 중...</div>
                </div>

                <!-- Custom Hook Input -->
                <div id="hook-custom-section" class="hidden px-4 pb-4">
                    <div class="border-t pt-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">직접 입력</div>
                        <div id="hook-custom-card" class="border-2 border-dashed border-gray-300 rounded-xl p-4 transition-all">
                            <textarea id="hook-custom-textarea" rows="3"
                                class="w-full text-sm border rounded-lg p-3 focus:ring-2 focus:ring-amber-300 focus:border-amber-400"
                                placeholder="나만의 훅을 직접 작성하세요 (1-3줄)"
                                oninput="onCustomHookInput()"
                                onfocus="activateCustomHook()"></textarea>
                            <div class="flex items-center justify-between mt-2">
                                <span id="hook-custom-counter" class="text-xs text-gray-500">0자</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Hook Actions -->
                <div id="hook-actions" class="hidden px-4 py-3 border-t bg-gray-50 flex items-center justify-between">
                    <span class="text-sm text-gray-600">
                        선택된 훅: <strong id="hook-selected-style" class="text-amber-700"></strong>
                    </span>
                    <div class="flex gap-2">
                        <button onclick="generateWithSelectedHook()"
                                class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                            이 훅으로 초안 생성
                        </button>
                        <button onclick="agentWithSelectedHook()"
                                class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                            이 훅으로 Agent 모드
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Instructions Panel (shown before starting agent) -->
        <div id="agent-instructions-panel" class="hidden mb-6">
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-purple-50 px-4 py-3 border-b flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-purple-700 font-semibold">Agent 추가 지시</span>
                        <span class="ml-2 text-sm text-purple-600">Agent에게 전달할 추가 지시를 입력하세요 (선택)</span>
                    </div>
                    <button onclick="closeAgentInstructionsPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-4">
                    <textarea
                        id="agent-instructions-input"
                        rows="3"
                        class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                        placeholder="예: 한국 시장 관점에서 분석해줘, 경쟁사 비교를 강조해줘, 개인 경험을 넣어줘..."
                    ></textarea>
                    <div class="flex justify-end gap-2 mt-3">
                        <button
                            onclick="confirmStartAgent()"
                            class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition"
                        >
                            Agent 실행
                        </button>
                        <button
                            onclick="confirmStartAgent(true)"
                            class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition"
                        >
                            지시 없이 실행
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Workspace (hidden by default) -->
        <div id="agent-workspace" class="hidden mb-6">
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-purple-50 px-4 py-3 border-b flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-purple-700 font-semibold">Agent Mode</span>
                        <span id="agent-status-badge" class="ml-2 px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">대기 중</span>
                    </div>
                    <button onclick="closeAgentWorkspace()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Steps Timeline -->
                <div id="agent-steps" class="p-4 space-y-1">
                    <!-- Steps will be dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Agent Result Panel (shown after agent completes, replaces page reload) -->
        <div id="agent-result-panel" class="hidden mb-6 space-y-4">
            <!-- Final Draft Display -->
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-green-50 px-4 py-3 border-b flex items-center justify-between">
                    <span class="text-green-700 font-semibold">최종 초안</span>
                    <div class="flex items-center gap-2">
                        <span id="agent-draft-char-count" class="text-xs text-gray-500"></span>
                        <button onclick="copyToClipboard(document.getElementById('agent-final-draft').innerText)"
                                class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            복사
                        </button>
                        <button onclick="toggleAgentEditor()"
                                class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            직접 편집
                        </button>
                        <button onclick="finalizeAgentDraft()"
                                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
                            확정
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="agent-final-draft" class="prose prose-sm max-w-none whitespace-pre-wrap text-gray-800"></div>
                </div>
            </div>

            <!-- Direct Editor (hidden by default) -->
            <div id="agent-editor-panel" class="hidden border rounded-lg overflow-hidden">
                <div class="bg-blue-50 px-4 py-3 border-b">
                    <span class="text-blue-700 font-semibold">직접 편집</span>
                </div>
                <div class="p-4">
                    <textarea id="agent-editor-textarea" rows="15"
                        class="w-full text-sm border rounded-lg p-3 focus:ring-2 focus:ring-blue-300 focus:border-blue-400"
                        oninput="updateEditorCharCount()"></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <span id="editor-char-counter" class="text-sm font-medium"></span>
                        <div class="flex gap-2">
                            <button onclick="cancelAgentEditor()"
                                    class="px-4 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="saveAgentEditor()"
                                    class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Evaluation Scorecard (auto-rendered after agent completes) -->
            <div id="agent-scorecard-panel" class="hidden"></div>

            <!-- Chat Interface -->
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-purple-50 px-4 py-3 border-b">
                    <span class="text-purple-700 font-semibold">채팅으로 개선</span>
                </div>
                <div class="p-4">
                    <div id="chat-messages" class="space-y-3 mb-4 max-h-80 overflow-y-auto"></div>
                    <!-- Quick Refine Palette -->
                    <div class="flex flex-wrap gap-1.5 mb-2" id="agent-quick-refine"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input"
                            class="flex-1 text-sm border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-300 focus:border-purple-400"
                            placeholder="수정 요청을 입력하세요... (예: 훅을 더 강렬하게)"
                            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendChatMessage()}">
                        <button onclick="sendChatMessage()" id="chat-send-btn"
                                class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 disabled:opacity-50">
                            전송
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Button (shown when 2+ drafts) -->
        {% if drafts|length >= 2 %}
        <div class="mt-6 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800">Drafts ({{ drafts|length }})</h3>
            <button id="compare-btn" onclick="toggleCompareMode()"
                    class="px-4 py-2 text-sm bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 font-medium">
                비교
            </button>
        </div>
        {% endif %}

        <!-- Compare Panel (hidden by default) -->
        <div id="compare-panel" class="hidden mt-4 border-2 border-emerald-200 rounded-xl p-5 bg-emerald-50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-emerald-800">드래프트 비교</h3>
                <button onclick="closeComparePanel()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>
            <div id="compare-content" class="compare-panel"></div>
        </div>

        <!-- Drafts Container -->
        <div id="drafts-container" class="mt-6 space-y-4">
            {% for draft in drafts|sort(attribute='version', reverse=true) %}
            <div class="border rounded-lg p-4 bg-gray-50 relative" data-draft-id="{{ draft.id }}">
                <!-- Compare checkbox (hidden by default) -->
                <input type="checkbox" class="compare-checkbox hidden" id="compare-cb-{{ draft.id }}"
                       onchange="onCompareSelect({{ draft.id }})" title="비교할 드래프트 선택">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">
                            Scenario {{ draft.scenario }}: {{ scenarios[draft.scenario].name }}
                        </span>
                        <span class="text-xs text-gray-500">Version {{ draft.version }}</span>
                        {% if draft.generation_mode == 'agent' %}
                        <span class="px-2 py-1 text-xs font-medium bg-purple-50 text-purple-600 rounded">Agent</span>
                        {% endif %}
                        {% if draft.status == 'final' %}
                        <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Final</span>
                        {% elif draft.status == 'published' %}
                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded">Published</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs" id="draft-char-badge-{{ draft.id }}"></span>
                        {% if draft.evaluation %}
                        <button onclick="toggleScorecard({{ draft.id }})"
                                class="px-3 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                            평가
                        </button>
                        {% endif %}
                        <button onclick="copyToClipboard(document.getElementById('draft-{{ draft.id }}').innerText)"
                                class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Copy
                        </button>
                        <button onclick="startDraftEdit({{ draft.id }})"
                                class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            편집
                        </button>
                        <button onclick="toggleDraftChat({{ draft.id }})"
                                class="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                            채팅
                        </button>
                        {% if draft.status == 'draft' %}
                        <button onclick="finalizeDraft({{ draft.id }})"
                                class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
                            Finalize
                        </button>
                        {% endif %}
                        <button
                            hx-post="/api/linkedin/regenerate/{{ draft.id }}"
                            hx-target="#drafts-container"
                            hx-swap="afterbegin"
                            class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                        >
                            Regenerate
                        </button>
                    </div>
                </div>
                <div id="draft-{{ draft.id }}" class="prose prose-sm max-w-none whitespace-pre-wrap text-gray-800">{{ draft.draft_content }}</div>

                <!-- Inline Edit Panel (hidden by default) -->
                <div id="draft-edit-{{ draft.id }}" class="hidden mt-3">
                    <textarea id="draft-edit-textarea-{{ draft.id }}" rows="15"
                        class="w-full text-sm border rounded-lg p-3 focus:ring-2 focus:ring-blue-300 focus:border-blue-400"
                        oninput="updateDraftEditCharCount({{ draft.id }})"></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <span id="draft-edit-counter-{{ draft.id }}" class="text-sm font-medium"></span>
                        <div class="flex gap-2">
                            <button onclick="cancelDraftEdit({{ draft.id }})"
                                    class="px-4 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
                                취소
                            </button>
                            <button onclick="saveDraftEdit({{ draft.id }})"
                                    class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                저장
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Draft Chat Panel (hidden by default) -->
                <div id="draft-chat-{{ draft.id }}" class="hidden mt-3 border rounded-lg overflow-hidden">
                    <div class="bg-purple-50 px-4 py-2 border-b">
                        <span class="text-purple-700 text-sm font-semibold">채팅으로 개선</span>
                    </div>
                    <div class="p-3">
                        <div id="draft-chat-messages-{{ draft.id }}" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div>
                        <!-- Quick Refine Palette -->
                        <div class="flex flex-wrap gap-1.5 mb-2" id="draft-quick-refine-{{ draft.id }}"></div>
                        <div class="flex gap-2">
                            <input type="text" id="draft-chat-input-{{ draft.id }}"
                                class="flex-1 text-sm border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-300 focus:border-purple-400"
                                placeholder="수정 요청을 입력하세요..."
                                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendDraftChat({{ draft.id }})}">
                            <button onclick="sendDraftChat({{ draft.id }})" id="draft-chat-send-{{ draft.id }}"
                                    class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 disabled:opacity-50">
                                전송
                            </button>
                        </div>
                    </div>
                </div>

                {% if draft.evaluation %}
                <!-- Scorecard panel (hidden by default, toggled by 평가 button) -->
                <div id="scorecard-{{ draft.id }}" class="hidden mt-3 pt-3 border-t"></div>
                {% endif %}

                <div class="mt-2 text-xs text-gray-400">
                    Created: {{ draft.created_at.strftime('%Y-%m-%d %H:%M') if draft.created_at else '' }}
                    {% if draft.generation_mode == 'agent' %}
                    | Iterations: {{ draft.iteration_count or 1 }}
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div id="no-drafts-message" class="text-center py-8 text-gray-500">
                <p>No drafts generated yet. Select a scenario and click "Generate Draft" to create one.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const articleId = {{ article.id }};
const scenarioSelect = document.getElementById('scenario-select');
const scenarioDescription = document.getElementById('scenario-description');
const scenarios = {{ scenarios | tojson | safe }};
const recommendedScenario = "{{ recommended_scenario }}";

// Evaluation data from existing drafts
const draftEvaluations = {};
{% for draft in drafts %}
{% if draft.evaluation %}
try { draftEvaluations[{{ draft.id }}] = JSON.parse({{ draft.evaluation | tojson }}); } catch(e) {}
{% endif %}
{% endfor %}

// Chat history from existing drafts
const draftChatHistories = {};
{% for draft in drafts %}
{% if draft.chat_history %}
try { draftChatHistories[{{ draft.id }}] = JSON.parse({{ draft.chat_history | tojson }}); } catch(e) {}
{% endif %}
{% endfor %}

// Agent state
let agentSessionId = null;
let agentDraftId = null;
let eventSource = null;
let stepReferenceData = {};
let agentAdditionalInstructions = '';
let selectedAgentHookIdx = null;

// Draft data for comparison
const allDrafts = {};
{% for draft in drafts %}
allDrafts[{{ draft.id }}] = {
    id: {{ draft.id }},
    scenario: "{{ draft.scenario or '' }}",
    version: {{ draft.version or 1 }},
    status: "{{ draft.status or 'draft' }}",
    generation_mode: "{{ draft.generation_mode or 'simple' }}",
    content: {{ draft.draft_content | tojson }},
};
{% endfor %}

// Compare mode state
let compareMode = false;
let compareSelected = [];

// Mark as read on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch(`/api/articles/${articleId}/read`, { method: 'POST' });
});

// Toggle favorite
async function toggleFavorite() {
    const btn = document.getElementById('favorite-btn');
    try {
        const response = await fetch(`/api/articles/${articleId}/favorite`, { method: 'POST' });
        const data = await response.json();

        if (data.is_favorite) {
            btn.innerHTML = '<span class="text-yellow-500">&#9733;</span>';
            btn.dataset.favorite = 'true';
        } else {
            btn.innerHTML = '<span class="text-gray-300 hover:text-yellow-400">&#9734;</span>';
            btn.dataset.favorite = 'false';
        }
        showToast(data.is_favorite ? 'Added to favorites' : 'Removed from favorites');
    } catch (e) {
        showToast('Failed to update favorite', 'error');
    }
}

// Select scenario function
function selectScenario(key) {
    scenarioSelect.value = key;
    scenarioDescription.textContent = scenarios[key].description;

    document.querySelectorAll('[id^="scenario-btn-"]').forEach(btn => {
        const btnKey = btn.id.replace('scenario-btn-', '');
        if (btnKey === key) {
            btn.classList.remove('border-gray-200', 'bg-white', 'text-gray-700');
            btn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
        } else {
            btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
            btn.classList.add('border-gray-200', 'bg-white', 'text-gray-700');
        }
    });
}

// --- Agent Mode ---

function showAgentInstructionsPanel() {
    const panel = document.getElementById('agent-instructions-panel');
    const input = document.getElementById('agent-instructions-input');
    panel.classList.remove('hidden');
    input.value = '';
    input.focus();
}

function closeAgentInstructionsPanel() {
    document.getElementById('agent-instructions-panel').classList.add('hidden');
}

function confirmStartAgent(skipInstructions) {
    const panel = document.getElementById('agent-instructions-panel');
    const input = document.getElementById('agent-instructions-input');

    if (skipInstructions) {
        agentAdditionalInstructions = '';
    } else {
        agentAdditionalInstructions = (input.value || '').trim();
    }

    panel.classList.add('hidden');
    startAgentMode();
}

function startAgentMode() {
    const workspace = document.getElementById('agent-workspace');
    workspace.classList.remove('hidden');
    document.getElementById('agent-btn').disabled = true;
    document.getElementById('generate-btn').disabled = true;

    const scenario = scenarioSelect.value;
    const stepsContainer = document.getElementById('agent-steps');
    stepsContainer.innerHTML = '';

    updateAgentStatus('연결 중...', 'bg-yellow-100 text-yellow-700');

    // Start SSE connection (with optional hook and instructions)
    let agentUrl = `/api/linkedin/agent/start/${articleId}?scenario=${scenario}`;
    if (selectedHookText) {
        agentUrl += `&hook=${encodeURIComponent(selectedHookText)}`;
    }
    if (agentAdditionalInstructions) {
        agentUrl += `&instructions=${encodeURIComponent(agentAdditionalInstructions)}`;
    }

    fetch(agentUrl, {
        method: 'POST',
    }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    handleAgentDone();
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                let currentEvent = '';
                let currentData = '';

                for (const line of lines) {
                    if (line.startsWith('event: ')) {
                        currentEvent = line.substring(7).trim();
                    } else if (line.startsWith('data: ')) {
                        currentData = line.substring(6);
                        if (currentEvent && currentData) {
                            try {
                                handleAgentEvent(currentEvent, JSON.parse(currentData));
                            } catch (e) {
                                console.error('Parse error:', e, currentData);
                            }
                            currentEvent = '';
                            currentData = '';
                        }
                    }
                }

                readStream();
            }).catch(err => {
                console.error('Stream error:', err);
                updateAgentStatus('오류 발생', 'bg-red-100 text-red-700');
            });
        }

        readStream();
    }).catch(err => {
        console.error('Agent start error:', err);
        updateAgentStatus('시작 실패', 'bg-red-100 text-red-700');
        document.getElementById('agent-btn').disabled = false;
        document.getElementById('generate-btn').disabled = false;
    });
}

function handleAgentEvent(event, data) {
    switch (event) {
        case 'session_created':
            agentSessionId = data.session_id;
            initStepTimeline(data.steps);
            updateAgentStatus('진행 중', 'bg-blue-100 text-blue-700');
            break;

        case 'step_start':
            activateStep(data.step, data.name);
            break;

        case 'step_content':
            if (data.iteration !== undefined) {
                // Step 4 자동 반복 진행 표시
                const iterMsg = data.passed
                    ? `반복 ${data.iteration}: 점수 ${data.score}, FAIL ${data.fail_count}개 → 통과`
                    : `반복 ${data.iteration}: 점수 ${data.score}, FAIL ${data.fail_count}개 → 수정 중...`;
                appendStepContent(data.step, iterMsg);
            } else {
                appendStepContent(data.step, JSON.stringify(data, null, 2));
            }
            break;

        case 'step_complete':
            if (data.reference_data) {
                stepReferenceData[data.step] = data.reference_data;
            }
            completeStep(data.step, data.content);
            break;

        case 'waiting_for_input':
            handleWaitingForInput(data);
            break;

        case 'input_received':
            resumeFromInput(data.step);
            break;

        case 'input_timeout':
            resumeFromInput(data.step);
            break;

        case 'agent_complete':
            handleAgentComplete(data);
            break;

        case 'agent_error':
            handleAgentError(data);
            break;
    }
}

function initStepTimeline(steps) {
    const container = document.getElementById('agent-steps');
    container.innerHTML = '';

    steps.forEach(step => {
        const stepEl = document.createElement('div');
        stepEl.id = `agent-step-${step.id}`;
        stepEl.className = 'agent-step pl-6 pb-4 relative';
        stepEl.innerHTML = `
            <div class="flex items-start">
                <div class="step-indicator pending" id="step-ind-${step.id}">${step.id + 1}</div>
                <div class="flex-1 ml-2">
                    <div class="flex items-center">
                        <span class="font-medium text-gray-700" id="step-title-${step.id}">${step.name}</span>
                        <span class="ml-2 text-xs text-gray-400">${step.description}</span>
                    </div>
                    <div class="step-content" id="step-content-${step.id}">
                        <div class="mt-2 text-sm text-gray-600 whitespace-pre-wrap" id="step-text-${step.id}"></div>
                        <div id="step-input-${step.id}"></div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(stepEl);
    });
}

function activateStep(stepId, name) {
    const stepEl = document.getElementById(`agent-step-${stepId}`);
    const indicator = document.getElementById(`step-ind-${stepId}`);
    const content = document.getElementById(`step-content-${stepId}`);

    if (stepEl) stepEl.classList.add('active');
    if (indicator) {
        indicator.classList.remove('pending');
        indicator.classList.add('active');
        indicator.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
    }
    if (content) content.classList.add('expanded');

    // Scroll to step
    stepEl?.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function completeStep(stepId, content) {
    const stepEl = document.getElementById(`agent-step-${stepId}`);
    const indicator = document.getElementById(`step-ind-${stepId}`);
    const textEl = document.getElementById(`step-text-${stepId}`);

    if (stepEl) {
        stepEl.classList.remove('active', 'waiting');
        stepEl.classList.add('completed');
    }
    if (indicator) {
        indicator.classList.remove('active', 'waiting');
        indicator.classList.add('completed');
        indicator.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
    }

    // For step 5 (evaluation), render scorecard summary and store data
    if (stepId === 5) {
        try {
            const evalData = JSON.parse(content);
            agentEvalData = evalData;
            textEl.innerHTML = renderEvaluationTable(evalData);
        } catch {
            textEl.textContent = content;
        }
    } else {
        textEl.textContent = content;
    }

    // Add reference data toggle if available
    const refData = stepReferenceData[stepId];
    if (refData) {
        const refKey = Object.keys(refData)[0];
        const refContent = typeof refData[refKey] === 'string' ? refData[refKey] : JSON.stringify(refData[refKey], null, 2);
        if (refContent && refContent.length > 0) {
            const refId = `ref-data-${stepId}`;
            const refHtml = `
                <div class="mt-2 border-t pt-2">
                    <button onclick="document.getElementById('${refId}').classList.toggle('expanded')" class="text-xs text-purple-600 hover:text-purple-800">
                        참고 자료 보기
                    </button>
                    <div id="${refId}" class="ref-data-content">
                        <pre class="mt-1 p-2 bg-gray-50 border rounded text-xs text-gray-600 whitespace-pre-wrap overflow-x-auto max-h-96 overflow-y-auto">${escapeHtml(refContent)}</pre>
                    </div>
                </div>`;
            textEl.insertAdjacentHTML('afterend', refHtml);
        }
    }

    // Make collapsible
    const contentEl = document.getElementById(`step-content-${stepId}`);
    const titleEl = document.getElementById(`step-title-${stepId}`);
    if (titleEl && contentEl) {
        titleEl.style.cursor = 'pointer';
        titleEl.onclick = () => contentEl.classList.toggle('expanded');
    }
}

function handleWaitingForInput(data) {
    const stepEl = document.getElementById(`agent-step-${data.step}`);
    const indicator = document.getElementById(`step-ind-${data.step}`);
    const inputEl = document.getElementById(`step-input-${data.step}`);

    if (stepEl) {
        stepEl.classList.remove('active');
        stepEl.classList.add('waiting');
    }
    if (indicator) {
        indicator.classList.remove('active');
        indicator.classList.add('waiting');
        indicator.innerHTML = '?';
    }

    updateAgentStatus('입력 대기', 'bg-yellow-100 text-yellow-700');

    if (data.type === 'hook_select') {
        // Hook 선택 UI
        const hooks = data.hooks || [];
        let hooksHtml = '';
        hooks.forEach((hook, idx) => {
            hooksHtml += `
                <div id="hook-card-${idx}" onclick="selectAgentHook(${idx})"
                     class="p-3 border rounded-lg cursor-pointer transition-all hover:border-yellow-400 ${idx === 0 ? 'border-yellow-500 bg-yellow-50' : 'border-gray-200'}">
                    <div class="flex items-start">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200 text-xs font-bold mr-2 flex-shrink-0">${idx + 1}</span>
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(hook)}</p>
                    </div>
                </div>`;
        });
        selectedAgentHookIdx = 0;
        inputEl.innerHTML = `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm font-medium text-yellow-800 mb-2">${data.prompt}</p>
                <div class="space-y-2">${hooksHtml}</div>
                <button onclick="submitHookSelection()" class="mt-3 px-4 py-1.5 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">선택 완료</button>
            </div>
        `;
    } else if (data.type === 'outline_feedback') {
        inputEl.innerHTML = `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm font-medium text-yellow-800 mb-2">${data.prompt}</p>
                <textarea id="outline-feedback" rows="3" class="w-full text-sm border rounded p-2" placeholder="수정 요청을 입력하세요... (없으면 비워두세요)"></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="submitOutlineFeedback()" class="px-4 py-1.5 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">피드백 전송</button>
                    <button onclick="skipOutlineFeedback()" class="px-4 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">승인 (건너뛰기)</button>
                </div>
            </div>
        `;
    } else if (data.type === 'direction_select') {
        inputEl.innerHTML = `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm font-medium text-yellow-800 mb-2">${data.prompt}</p>
                <div class="space-y-2">
                    <label class="flex items-center"><input type="radio" name="direction" value="1" checked class="mr-2"> 방향 1</label>
                    <label class="flex items-center"><input type="radio" name="direction" value="2" class="mr-2"> 방향 2</label>
                    <label class="flex items-center"><input type="radio" name="direction" value="3" class="mr-2"> 방향 3</label>
                    <div class="mt-2">
                        <label class="flex items-center"><input type="radio" name="direction" value="custom" class="mr-2"> 직접 입력:</label>
                        <textarea id="custom-direction" rows="2" class="mt-1 w-full text-sm border rounded p-2" placeholder="원하는 방향을 직접 입력하세요..."></textarea>
                    </div>
                </div>
                <button onclick="submitDirection()" class="mt-2 px-4 py-1.5 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">선택 완료</button>
            </div>
        `;
    } else if (data.type === 'draft_feedback') {
        inputEl.innerHTML = `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm font-medium text-yellow-800 mb-2">${data.prompt}</p>
                <textarea id="draft-feedback" rows="3" class="w-full text-sm border rounded p-2" placeholder="피드백을 입력하세요... (없으면 비워두세요)"></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="submitFeedback()" class="px-4 py-1.5 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">피드백 전송</button>
                    <button onclick="skipFeedback()" class="px-4 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">건너뛰기</button>
                </div>
            </div>
        `;
    }
}

async function submitDirection() {
    if (!agentSessionId) return;

    const selected = document.querySelector('input[name="direction"]:checked');
    let direction = selected ? selected.value : '1';

    if (direction === 'custom') {
        const customText = document.getElementById('custom-direction').value;
        direction = customText || '1';
    }

    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ direction: direction })
    });
}

async function submitFeedback() {
    if (!agentSessionId) return;

    const feedback = document.getElementById('draft-feedback').value;
    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: feedback })
    });
}

async function skipFeedback() {
    if (!agentSessionId) return;

    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: '' })
    });
}

function selectAgentHook(idx) {
    selectedAgentHookIdx = idx;
    // Update visual selection
    document.querySelectorAll('[id^="hook-card-"]').forEach((el, i) => {
        if (i === idx) {
            el.classList.add('border-yellow-500', 'bg-yellow-50');
            el.classList.remove('border-gray-200');
        } else {
            el.classList.remove('border-yellow-500', 'bg-yellow-50');
            el.classList.add('border-gray-200');
        }
    });
}

async function submitHookSelection() {
    if (!agentSessionId) return;

    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hook_index: selectedAgentHookIdx ?? 0 })
    });
}

async function submitOutlineFeedback() {
    if (!agentSessionId) return;

    const feedback = document.getElementById('outline-feedback').value;
    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: feedback })
    });
}

async function skipOutlineFeedback() {
    if (!agentSessionId) return;

    await fetch(`/api/linkedin/agent/${agentSessionId}/input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: '' })
    });
}

function resumeFromInput(stepId) {
    const inputEl = document.getElementById(`step-input-${stepId}`);
    if (inputEl) inputEl.innerHTML = '<p class="text-xs text-green-600 mt-1">입력 완료</p>';
    updateAgentStatus('진행 중', 'bg-blue-100 text-blue-700');
}

function handleAgentComplete(data) {
    updateAgentStatus('완료', 'bg-green-100 text-green-700');
    document.getElementById('agent-btn').disabled = false;
    document.getElementById('generate-btn').disabled = false;

    agentDraftId = data.draft_id;

    // Show result panel inline
    const resultPanel = document.getElementById('agent-result-panel');
    const draftDisplay = document.getElementById('agent-final-draft');
    const charCount = document.getElementById('agent-draft-char-count');

    draftDisplay.textContent = data.final_draft;
    charCount.textContent = `${data.final_draft.length}자`;
    resultPanel.classList.remove('hidden');

    // Auto-render evaluation scorecard from step 5 data
    if (agentEvalData) {
        const scorecardPanel = document.getElementById('agent-scorecard-panel');
        scorecardPanel.classList.remove('hidden');
        renderEvaluationScorecard(agentEvalData, 'agent-scorecard-panel');
    }

    // Collapse step details
    for (let i = 0; i <= 5; i++) {
        const contentEl = document.getElementById(`step-content-${i}`);
        if (contentEl) contentEl.classList.remove('expanded');
    }

    resultPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    showToast('Agent 모드 완료! 최종 초안이 저장되었습니다.', 'success');
}

function handleAgentError(data) {
    updateAgentStatus('오류', 'bg-red-100 text-red-700');
    document.getElementById('agent-btn').disabled = false;
    document.getElementById('generate-btn').disabled = false;
    showToast(`Agent 오류: ${data.message}`, 'error');
}

function handleAgentDone() {
    // Stream ended
    if (document.getElementById('agent-status-badge').textContent === '진행 중') {
        updateAgentStatus('완료', 'bg-green-100 text-green-700');
    }
}

function updateAgentStatus(text, classes) {
    const badge = document.getElementById('agent-status-badge');
    badge.textContent = text;
    badge.className = `ml-2 px-2 py-0.5 text-xs rounded-full ${classes}`;
}

function closeAgentWorkspace() {
    document.getElementById('agent-workspace').classList.add('hidden');
    document.getElementById('agent-btn').disabled = false;
    document.getElementById('generate-btn').disabled = false;
}

function appendStepContent(stepId, content) {
    const textEl = document.getElementById(`step-text-${stepId}`);
    if (textEl) {
        if (textEl.textContent) textEl.textContent += '\n';
        textEl.textContent += content;
    }
}

// --- Evaluation Scorecard ---

let agentEvalData = null; // stored from step 5 for agent result panel

function renderEvaluationScorecard(evalData, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const data = typeof evalData === 'string' ? JSON.parse(evalData) : evalData;
    if (data.error) {
        container.innerHTML = `<p class="text-red-500 text-sm">${escapeHtml(data.error)}</p>`;
        return;
    }

    const score = data.overall_score || 0;
    const scoreColorClass = score >= 80 ? 'score-green' : score >= 60 ? 'score-yellow' : 'score-red';

    // Group items by category
    const groups = {};
    const categoryOrder = ['문체', '구조', '금지', '형식'];
    (data.items || []).forEach(item => {
        if (!groups[item.category]) groups[item.category] = [];
        groups[item.category].push(item);
    });

    // Score header
    let html = `<div class="p-4 space-y-4">
        <div class="flex items-center gap-4">
            <div class="scorecard-score-circle ${scoreColorClass}">
                <span class="score-number">${score}</span>
                <span class="score-label">점</span>
            </div>
            <div>
                <div class="text-sm font-semibold text-gray-700">가이드라인 평가</div>
                <div class="text-xs text-gray-500">${(data.items || []).filter(i => i.pass).length}/${(data.items || []).length} 항목 통과</div>
            </div>
        </div>`;

    // Category groups
    const categoryColors = { '문체': 'indigo', '구조': 'blue', '금지': 'red', '형식': 'gray' };
    const orderedCategories = categoryOrder.filter(c => groups[c]);
    // Add any extra categories not in the predefined order
    Object.keys(groups).forEach(c => { if (!orderedCategories.includes(c)) orderedCategories.push(c); });

    html += `<div class="space-y-3">`;
    orderedCategories.forEach(cat => {
        const items = groups[cat];
        const passCount = items.filter(i => i.pass).length;
        const allPass = passCount === items.length;
        const allFail = passCount === 0;
        const borderClass = allPass ? 'cat-pass' : allFail ? 'cat-fail' : 'cat-mixed';
        const color = categoryColors[cat] || 'gray';

        html += `<div class="scorecard-category ${borderClass}">
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-semibold text-${color}-600 uppercase">${escapeHtml(cat)}</span>
                <span class="text-xs text-gray-400">${passCount}/${items.length}</span>
            </div>
            <div class="space-y-1">`;

        items.forEach(item => {
            const icon = item.pass
                ? '<span class="scorecard-item-pass font-bold">✓</span>'
                : '<span class="scorecard-item-fail font-bold">✗</span>';
            html += `<div class="flex items-start gap-2 text-xs">
                <span class="flex-shrink-0 w-4 text-center">${icon}</span>
                <span class="text-gray-700">${escapeHtml(item.rule)}</span>
                <span class="text-gray-400 ml-auto flex-shrink-0">${escapeHtml(item.comment)}</span>
            </div>`;
        });

        html += `</div></div>`;
    });
    html += `</div>`;

    // Summary
    if (data.summary) {
        html += `<div class="text-xs text-gray-500 pt-2 border-t">${escapeHtml(data.summary)}</div>`;
    }

    html += `</div>`;
    container.innerHTML = html;
}

// Legacy function kept for agent step 5 timeline rendering
function renderEvaluationTable(evalData) {
    if (evalData.error) return `<p class="text-red-500">${evalData.error}</p>`;
    // Use scorecard format inline
    const score = evalData.overall_score || 0;
    const scoreColorClass = score >= 80 ? 'score-green' : score >= 60 ? 'score-yellow' : 'score-red';
    let html = `<div class="flex items-center gap-3 mt-2">
        <div class="scorecard-score-circle ${scoreColorClass}" style="width:48px;height:48px;">
            <span style="font-size:20px;font-weight:700;line-height:1">${score}</span>
            <span style="font-size:9px;opacity:0.8">점</span>
        </div>
        <span class="text-sm text-gray-600">${(evalData.items || []).filter(i => i.pass).length}/${(evalData.items || []).length} 항목 통과</span>
    </div>`;
    return html;
}

function toggleScorecard(draftId) {
    const panel = document.getElementById(`scorecard-${draftId}`);
    if (!panel) return;

    if (panel.classList.contains('hidden')) {
        const data = draftEvaluations[draftId];
        if (data && !panel.dataset.rendered) {
            renderEvaluationScorecard(data, `scorecard-${draftId}`);
            panel.dataset.rendered = '1';
        }
        panel.classList.remove('hidden');
    } else {
        panel.classList.add('hidden');
    }
}

// --- Finalize Draft ---

async function finalizeDraft(draftId) {
    try {
        const resp = await fetch(`/api/linkedin/drafts/${draftId}/finalize`, { method: 'POST' });
        if (resp.ok) {
            showToast('Draft finalized!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('Failed to finalize', 'error');
        }
    } catch (e) {
        showToast('Error finalizing draft', 'error');
    }
}

// --- Draft Compare Mode ---

function toggleCompareMode() {
    compareMode = !compareMode;
    compareSelected = [];
    const btn = document.getElementById('compare-btn');
    const checkboxes = document.querySelectorAll('.compare-checkbox');

    if (compareMode) {
        btn.textContent = '비교 취소';
        btn.className = 'px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium';
        checkboxes.forEach(cb => { cb.classList.remove('hidden'); cb.checked = false; });
    } else {
        btn.textContent = '비교';
        btn.className = 'px-4 py-2 text-sm bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 font-medium';
        checkboxes.forEach(cb => cb.classList.add('hidden'));
        closeComparePanel();
    }
}

function onCompareSelect(draftId) {
    const cb = document.getElementById(`compare-cb-${draftId}`);
    if (cb.checked) {
        if (compareSelected.length >= 2) {
            // Uncheck the oldest selection
            const oldId = compareSelected.shift();
            document.getElementById(`compare-cb-${oldId}`).checked = false;
        }
        compareSelected.push(draftId);
    } else {
        compareSelected = compareSelected.filter(id => id !== draftId);
    }

    if (compareSelected.length === 2) {
        renderComparePanel(compareSelected[0], compareSelected[1]);
    } else {
        closeComparePanel();
    }
}

function renderComparePanel(id1, id2) {
    const panel = document.getElementById('compare-panel');
    const container = document.getElementById('compare-content');

    const d1 = allDrafts[id1];
    const d2 = allDrafts[id2];
    if (!d1 || !d2) return;

    const content1 = document.getElementById(`draft-${id1}`)?.textContent || d1.content;
    const content2 = document.getElementById(`draft-${id2}`)?.textContent || d2.content;

    const len1 = content1.length;
    const len2 = content2.length;
    const maxLen = Math.max(len1, len2, 1);

    const eval1 = draftEvaluations[id1];
    const eval2 = draftEvaluations[id2];

    function getHook(text) {
        const lines = text.split('\n');
        return lines[0] || '';
    }

    function getScoreColor(s) {
        if (s >= 80) return 'bg-green-100 text-green-700';
        if (s >= 60) return 'bg-yellow-100 text-yellow-700';
        return 'bg-red-100 text-red-700';
    }

    function getCharClass(len) {
        if (len > 3000) return 'bg-red-500';
        if (len > 2000) return 'bg-yellow-500';
        return 'bg-green-500';
    }

    function getScenarioName(sc) {
        return scenarios[sc] ? `${sc}: ${scenarios[sc].name}` : (sc || '-');
    }

    function renderSide(draft, content, evalData, charLen) {
        const hook = getHook(content);
        const scoreBadge = evalData && evalData.overall_score != null
            ? `<span class="px-2 py-0.5 text-xs font-bold rounded ${getScoreColor(evalData.overall_score)}">${evalData.overall_score}점</span>`
            : '<span class="text-xs text-gray-400">평가 없음</span>';
        const barPct = Math.round((charLen / maxLen) * 100);
        const isFinal = draft.status === 'final';

        return `
            <div class="compare-card ${isFinal ? 'selected-final' : ''}">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 rounded">${getScenarioName(draft.scenario)}</span>
                        <span class="text-xs text-gray-500">v${draft.version}</span>
                        ${draft.generation_mode === 'agent' ? '<span class="px-1.5 py-0.5 text-xs bg-purple-50 text-purple-600 rounded">Agent</span>' : ''}
                        ${isFinal ? '<span class="px-1.5 py-0.5 text-xs bg-green-100 text-green-700 rounded font-medium">Final</span>' : ''}
                    </div>
                    ${scoreBadge}
                </div>
                <div class="compare-hook mb-3">${escapeHtml(hook)}</div>
                <div class="text-sm text-gray-600 whitespace-pre-wrap max-h-40 overflow-y-auto mb-3">${escapeHtml(content.substring(hook.length).trim())}</div>
                <div class="mb-3">
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                        <span>글자수</span>
                        <span class="font-medium ${charLen > 3000 ? 'text-red-600' : charLen > 2000 ? 'text-yellow-600' : 'text-green-600'}">${charLen}자</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="compare-bar ${getCharClass(charLen)}" style="width: ${barPct}%"></div>
                    </div>
                </div>
                ${!isFinal ? `<button onclick="finalizeFromCompare(${draft.id})" class="w-full py-2 text-sm font-medium bg-green-600 text-white rounded-lg hover:bg-green-700">이 버전 사용</button>` : '<div class="text-center text-sm text-green-600 font-medium py-2">선택된 버전</div>'}
            </div>
        `;
    }

    container.innerHTML = renderSide(d1, content1, eval1, len1) + renderSide(d2, content2, eval2, len2);
    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function closeComparePanel() {
    document.getElementById('compare-panel').classList.add('hidden');
}

async function finalizeFromCompare(draftId) {
    try {
        const resp = await fetch(`/api/linkedin/drafts/${draftId}/finalize`, { method: 'POST' });
        if (resp.ok) {
            showToast('이 버전으로 확정!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('확정 실패', 'error');
        }
    } catch (e) {
        showToast('오류 발생', 'error');
    }
}

// Remove "no drafts" message when a draft is generated
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'drafts-container') {
        const noMessage = document.getElementById('no-drafts-message');
        if (noMessage) noMessage.remove();
        showToast('Draft generated successfully!', 'success');
    }
});

// --- Quick Refine Prompts ---

const QUICK_REFINE_PROMPTS = [
    { label: '훅 강화', prompt: '첫 줄(훅)을 더 강렬하고 호기심을 유발하도록 수정해줘. 숫자, 질문, 역설 등 강한 훅 기법을 사용해.' },
    { label: '본문 축약', prompt: '본문을 더 간결하게 축약해줘. 핵심 메시지는 유지하되 불필요한 문장과 반복을 제거해.' },
    { label: '톤 부드럽게', prompt: '전체적인 톤을 부드럽고 친근하게 바꿔줘. 딱딱한 표현을 대화하는 듯한 자연스러운 문체로 수정해.' },
    { label: '데이터 추가', prompt: '설득력을 높이기 위해 구체적인 수치, 통계, 연구 결과 등 데이터 포인트를 추가해줘.' },
    { label: '마무리 교체', prompt: '마지막 문단(마무리/CTA)을 새로운 방식으로 교체해줘. 독자의 행동을 유도하거나 생각할 거리를 남기는 마무리로.' },
];

function sendQuickRefine(promptText, targetType, targetId) {
    if (targetType === 'agent') {
        const input = document.getElementById('chat-input');
        input.value = promptText;
        sendChatMessage();
    } else if (targetType === 'draft') {
        const input = document.getElementById(`draft-chat-input-${targetId}`);
        input.value = promptText;
        sendDraftChat(targetId);
    }
}

function renderQuickRefineButtons(containerId, targetType, targetId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = QUICK_REFINE_PROMPTS.map(qr =>
        `<button onclick="sendQuickRefine(\`${qr.prompt}\`, '${targetType}'${targetId !== undefined ? `, ${targetId}` : ''})"
                title="${qr.prompt}"
                class="px-2.5 py-1 text-xs bg-gray-100 text-gray-600 rounded-full hover:bg-purple-100 hover:text-purple-700 transition">${qr.label}</button>`
    ).join('');
}

// --- Chat ---

async function sendChatMessage() {
    // Fall back to draft-based chat if no session (e.g., after page refresh)
    if (!agentSessionId && !agentDraftId) return;

    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;

    const sendBtn = document.getElementById('chat-send-btn');
    sendBtn.disabled = true;
    input.value = '';

    // Add user message to UI
    appendChatMessage('user', msg);

    // Show loading
    const loadingId = 'chat-loading-' + Date.now();
    const messagesEl = document.getElementById('chat-messages');
    messagesEl.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex"><div class="chat-msg-assistant px-3 py-2 text-sm text-gray-500">수정 중...</div></div>`);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    // Choose endpoint: session-based if session exists, draft-based as fallback
    const chatUrl = agentSessionId
        ? `/api/linkedin/agent/${agentSessionId}/chat`
        : `/api/linkedin/drafts/${agentDraftId}/chat`;

    try {
        const resp = await fetch(chatUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg }),
        });

        const data = await resp.json();
        document.getElementById(loadingId)?.remove();

        if (resp.ok) {
            appendChatMessage('assistant', `수정 완료 (${data.char_count}자)`);
            // Update draft display
            const revised = data.revised_draft || data.updated_content;
            document.getElementById('agent-final-draft').textContent = revised;
            document.getElementById('agent-draft-char-count').textContent = `${data.char_count}자`;
        } else {
            // If session expired, switch to draft-based and retry
            if (resp.status === 404 && agentSessionId && agentDraftId) {
                agentSessionId = null;
                document.getElementById(loadingId)?.remove();
                // Re-add user message input and retry
                input.value = msg;
                sendBtn.disabled = false;
                appendChatMessage('assistant', '세션이 만료되어 draft 기반 채팅으로 전환합니다. 다시 전송해주세요.');
                return;
            }
            appendChatMessage('assistant', `오류: ${data.detail || '알 수 없는 오류'}`);
        }
    } catch (e) {
        document.getElementById(loadingId)?.remove();
        appendChatMessage('assistant', `오류: ${e.message}`);
    }

    sendBtn.disabled = false;
    input.focus();
}

function appendChatMessage(role, content) {
    const messagesEl = document.getElementById('chat-messages');
    const cssClass = role === 'user' ? 'chat-msg-user' : 'chat-msg-assistant';
    const align = role === 'user' ? 'justify-end' : 'justify-start';
    messagesEl.insertAdjacentHTML('beforeend',
        `<div class="flex ${align}"><div class="${cssClass} px-3 py-2 text-sm">${escapeHtml(content)}</div></div>`
    );
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// --- Direct Editor ---

function toggleAgentEditor() {
    const panel = document.getElementById('agent-editor-panel');
    const textarea = document.getElementById('agent-editor-textarea');

    if (panel.classList.contains('hidden')) {
        textarea.value = document.getElementById('agent-final-draft').textContent;
        panel.classList.remove('hidden');
        updateEditorCharCount();
        textarea.focus();
    } else {
        panel.classList.add('hidden');
    }
}

function cancelAgentEditor() {
    document.getElementById('agent-editor-panel').classList.add('hidden');
}

async function saveAgentEditor() {
    if (!agentDraftId) return;

    const content = document.getElementById('agent-editor-textarea').value;

    try {
        const resp = await fetch(`/api/linkedin/drafts/${agentDraftId}/content`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content }),
        });

        if (resp.ok) {
            const data = await resp.json();
            document.getElementById('agent-final-draft').textContent = content;
            document.getElementById('agent-draft-char-count').textContent = `${data.char_count}자`;
            document.getElementById('agent-editor-panel').classList.add('hidden');
            showToast('저장 완료', 'success');
        } else {
            showToast('저장 실패', 'error');
        }
    } catch (e) {
        showToast('저장 오류', 'error');
    }
}

function updateEditorCharCount() {
    const textarea = document.getElementById('agent-editor-textarea');
    const counter = document.getElementById('editor-char-counter');
    const len = textarea.value.length;

    let colorClass, label;
    if (len < 1800) {
        colorClass = 'char-danger';
        label = '너무 짧음';
    } else if (len < 2200) {
        colorClass = 'char-warning';
        label = '짧음';
    } else if (len <= 2600) {
        colorClass = 'char-ideal';
        label = '이상적 범위';
    } else if (len <= 2800) {
        colorClass = 'char-warning';
        label = '약간 김';
    } else {
        colorClass = 'char-danger';
        label = '너무 김';
    }

    counter.innerHTML = `<span class="${colorClass}">${len}자 (${label})</span>`;
}

async function finalizeAgentDraft() {
    if (!agentDraftId) return;

    try {
        const resp = await fetch(`/api/linkedin/drafts/${agentDraftId}/finalize`, { method: 'POST' });
        if (resp.ok) {
            showToast('확정 완료!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('확정 실패', 'error');
        }
    } catch (e) {
        showToast('확정 오류', 'error');
    }
}

// --- Utility ---

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// --- Draft-based Chat ---

function toggleDraftChat(draftId) {
    const panel = document.getElementById(`draft-chat-${draftId}`);
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        // Load existing chat history if not already rendered
        const messagesEl = document.getElementById(`draft-chat-messages-${draftId}`);
        if (messagesEl.children.length === 0 && draftChatHistories[draftId]) {
            draftChatHistories[draftId].forEach(msg => {
                appendDraftChatMessage(draftId, msg.role, msg.content);
            });
        }
        document.getElementById(`draft-chat-input-${draftId}`).focus();
    } else {
        panel.classList.add('hidden');
    }
}

async function sendDraftChat(draftId) {
    const input = document.getElementById(`draft-chat-input-${draftId}`);
    const msg = input.value.trim();
    if (!msg) return;

    const sendBtn = document.getElementById(`draft-chat-send-${draftId}`);
    sendBtn.disabled = true;
    input.value = '';

    appendDraftChatMessage(draftId, 'user', msg);

    // Loading indicator
    const loadingId = `draft-chat-loading-${Date.now()}`;
    const messagesEl = document.getElementById(`draft-chat-messages-${draftId}`);
    messagesEl.insertAdjacentHTML('beforeend',
        `<div id="${loadingId}" class="flex"><div class="chat-msg-assistant px-3 py-2 text-sm text-gray-500">수정 중...</div></div>`);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    try {
        const resp = await fetch(`/api/linkedin/drafts/${draftId}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg }),
        });

        const data = await resp.json();
        document.getElementById(loadingId)?.remove();

        if (resp.ok) {
            appendDraftChatMessage(draftId, 'assistant', `수정 완료 (${data.char_count}자)`);
            // Update draft text and char count badge
            document.getElementById(`draft-${draftId}`).textContent = data.updated_content;
            updateDraftCharBadge(draftId, data.char_count);
        } else {
            appendDraftChatMessage(draftId, 'assistant', `오류: ${data.detail || '알 수 없는 오류'}`);
        }
    } catch (e) {
        document.getElementById(loadingId)?.remove();
        appendDraftChatMessage(draftId, 'assistant', `오류: ${e.message}`);
    }

    sendBtn.disabled = false;
    input.focus();
}

function appendDraftChatMessage(draftId, role, content) {
    const messagesEl = document.getElementById(`draft-chat-messages-${draftId}`);
    const cssClass = role === 'user' ? 'chat-msg-user' : 'chat-msg-assistant';
    const align = role === 'user' ? 'justify-end' : 'justify-start';
    messagesEl.insertAdjacentHTML('beforeend',
        `<div class="flex ${align}"><div class="${cssClass} px-3 py-2 text-sm">${escapeHtml(content)}</div></div>`
    );
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// --- Draft Inline Edit ---

function startDraftEdit(draftId) {
    const editPanel = document.getElementById(`draft-edit-${draftId}`);
    const textarea = document.getElementById(`draft-edit-textarea-${draftId}`);
    const draftContent = document.getElementById(`draft-${draftId}`).textContent;

    if (editPanel.classList.contains('hidden')) {
        textarea.value = draftContent;
        editPanel.classList.remove('hidden');
        updateDraftEditCharCount(draftId);
        textarea.focus();
    } else {
        editPanel.classList.add('hidden');
    }
}

function cancelDraftEdit(draftId) {
    document.getElementById(`draft-edit-${draftId}`).classList.add('hidden');
}

async function saveDraftEdit(draftId) {
    const content = document.getElementById(`draft-edit-textarea-${draftId}`).value;

    try {
        const resp = await fetch(`/api/linkedin/drafts/${draftId}/content`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content }),
        });

        if (resp.ok) {
            const data = await resp.json();
            document.getElementById(`draft-${draftId}`).textContent = content;
            updateDraftCharBadge(draftId, data.char_count);
            document.getElementById(`draft-edit-${draftId}`).classList.add('hidden');
            showToast('저장 완료', 'success');
        } else {
            showToast('저장 실패', 'error');
        }
    } catch (e) {
        showToast('저장 오류', 'error');
    }
}

function updateDraftEditCharCount(draftId) {
    const textarea = document.getElementById(`draft-edit-textarea-${draftId}`);
    const counter = document.getElementById(`draft-edit-counter-${draftId}`);
    const len = textarea.value.length;
    counter.innerHTML = `<span class="${getCharCountClass(len)}">${len}자 (${getCharCountLabel(len)})</span>`;
}

// --- Char Count Helpers ---

function getCharCountClass(len) {
    if (len < 1800) return 'char-danger';
    if (len < 2200) return 'char-warning';
    if (len <= 2600) return 'char-ideal';
    if (len <= 2800) return 'char-warning';
    return 'char-danger';
}

function getCharCountLabel(len) {
    if (len < 1800) return '너무 짧음';
    if (len < 2200) return '짧음';
    if (len <= 2600) return '이상적 범위';
    if (len <= 2800) return '약간 김';
    return '너무 김';
}

function updateDraftCharBadge(draftId, charCount) {
    const badge = document.getElementById(`draft-char-badge-${draftId}`);
    if (badge) {
        badge.innerHTML = `<span class="${getCharCountClass(charCount)}">${charCount}자</span>`;
    }
}

// Initialize char count badges and quick refine buttons on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for draft in drafts %}
    (function() {
        const el = document.getElementById('draft-{{ draft.id }}');
        if (el) updateDraftCharBadge({{ draft.id }}, el.textContent.length);
    })();
    {% endfor %}

    // Render quick refine buttons
    renderQuickRefineButtons('agent-quick-refine', 'agent');
    {% for draft in drafts %}
    renderQuickRefineButtons('draft-quick-refine-{{ draft.id }}', 'draft', {{ draft.id }});
    {% endfor %}
});

// --- Hook Lab ---

let selectedHookText = null;
let generatedHooks = [];

async function startHookLab() {
    const panel = document.getElementById('hook-lab-panel');
    const cardsContainer = document.getElementById('hook-cards');
    const spinner = document.getElementById('hook-lab-spinner');
    const btn = document.getElementById('hook-lab-btn');

    panel.classList.remove('hidden');
    cardsContainer.innerHTML = '<div class="text-center text-gray-500 py-4"><svg class="animate-spin h-6 w-6 mx-auto mb-2 text-amber-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>훅 생성 중...</div>';
    document.getElementById('hook-actions').classList.add('hidden');
    document.getElementById('hook-custom-section').classList.add('hidden');
    // Reset custom hook input
    const customTextarea = document.getElementById('hook-custom-textarea');
    if (customTextarea) { customTextarea.value = ''; }
    const customCounter = document.getElementById('hook-custom-counter');
    if (customCounter) { customCounter.textContent = '0자'; }
    deactivateCustomHook();
    selectedHookText = null;
    btn.disabled = true;
    spinner.classList.remove('hidden');

    const scenario = scenarioSelect.value;

    try {
        const resp = await fetch(`/api/linkedin/hooks/${articleId}?scenario=${scenario}`, {
            method: 'POST',
        });

        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Hook generation failed');
        }

        const data = await resp.json();
        generatedHooks = data.hooks || [];
        renderHookCards(generatedHooks);

        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (e) {
        cardsContainer.innerHTML = `<div class="text-center text-red-500 py-4">훅 생성 실패: ${escapeHtml(e.message)}</div>`;
    }

    btn.disabled = false;
    spinner.classList.add('hidden');
}

function closeHookLab() {
    document.getElementById('hook-lab-panel').classList.add('hidden');
    document.getElementById('hook-custom-section').classList.add('hidden');
    selectedHookText = null;
}

const hookStyleColors = {
    '숫자형': 'bg-blue-100 text-blue-700',
    '질문형': 'bg-green-100 text-green-700',
    '역설': 'bg-red-100 text-red-700',
    '선언': 'bg-purple-100 text-purple-700',
    '스토리': 'bg-amber-100 text-amber-700',
};

function renderHookCards(hooks) {
    const container = document.getElementById('hook-cards');

    if (!hooks || hooks.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">훅을 생성하지 못했습니다. 다시 시도해주세요.</div>';
        return;
    }

    container.innerHTML = '';
    hooks.forEach((hook, idx) => {
        const colorClass = hookStyleColors[hook.style] || 'bg-gray-100 text-gray-700';
        const preview = renderLinkedInPreview(hook.hook);

        const card = document.createElement('div');
        card.className = 'hook-card';
        card.id = `hook-card-${idx}`;
        card.onclick = () => selectHook(idx);
        card.innerHTML = `
            <div class="flex items-start justify-between mb-2">
                <span class="hook-style-badge ${colorClass}">${escapeHtml(hook.style)}</span>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400" id="hook-char-${idx}">${hook.hook.length}자</span>
                    <button onclick="event.stopPropagation(); copyHookText(${idx}, this)" class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200">복사</button>
                    <button onclick="event.stopPropagation(); startHookEdit(${idx})" class="px-2 py-0.5 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100">편집</button>
                </div>
            </div>
            <div id="hook-display-${idx}">
                <div class="hook-preview">${preview}</div>
                <div class="mt-2 text-xs text-gray-500">${escapeHtml(hook.reasoning)}</div>
            </div>
            <div id="hook-edit-${idx}" class="hidden mt-2">
                <textarea id="hook-edit-textarea-${idx}" class="w-full text-sm border rounded-lg p-3 focus:ring-2 focus:ring-amber-300 focus:border-amber-400" rows="4" oninput="updateHookEditCharCount(${idx})" onclick="event.stopPropagation()">${escapeHtml(hook.hook)}</textarea>
                <div class="flex items-center justify-between mt-2">
                    <span id="hook-edit-counter-${idx}" class="text-xs text-gray-500">${hook.hook.length}자</span>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); cancelHookEdit(${idx})" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">취소</button>
                        <button onclick="event.stopPropagation(); saveHookEdit(${idx})" class="px-3 py-1 text-xs bg-amber-500 text-white rounded hover:bg-amber-600">저장</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });

    // Show custom hook section
    document.getElementById('hook-custom-section').classList.remove('hidden');
}

function renderLinkedInPreview(hookText) {
    // LinkedIn '더보기' 접힘점: 약 210자 또는 줄바꿈 3번째
    const lines = hookText.split('\n');
    let visibleText = hookText;
    let isFolded = false;

    if (hookText.length > 210) {
        visibleText = hookText.substring(0, 210);
        isFolded = true;
    } else if (lines.length > 3) {
        visibleText = lines.slice(0, 3).join('\n');
        isFolded = true;
    }

    let html = escapeHtml(visibleText);
    if (isFolded) {
        html += '<span class="fold-indicator">... 더보기</span>';
    }
    return html;
}

function selectHook(idx) {
    // Deselect all hook cards
    document.querySelectorAll('.hook-card').forEach(c => c.classList.remove('selected'));
    // Select this one
    document.getElementById(`hook-card-${idx}`).classList.add('selected');

    // Deselect custom hook (mutual exclusivity)
    deactivateCustomHook();

    selectedHookText = generatedHooks[idx].hook;
    const actions = document.getElementById('hook-actions');
    actions.classList.remove('hidden');
    document.getElementById('hook-selected-style').textContent = generatedHooks[idx].style;
}

async function generateWithHook() {
    const scenario = scenarioSelect.value;
    const btn = document.getElementById('generate-btn');
    const spinner = document.getElementById('generate-spinner');

    btn.disabled = true;
    spinner.classList.remove('hidden');

    let url = `/api/linkedin/generate/${articleId}?scenario=${scenario}`;
    if (selectedHookText) {
        url += `&hook=${encodeURIComponent(selectedHookText)}`;
    }

    try {
        const resp = await fetch(url, { method: 'POST' });
        const data = await resp.json();

        if (resp.ok) {
            // Remove "no drafts" message
            const noMessage = document.getElementById('no-drafts-message');
            if (noMessage) noMessage.remove();

            // Insert draft HTML at top of container (reload to get proper template)
            showToast('Draft generated successfully!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(`생성 실패: ${data.detail || '알 수 없는 오류'}`, 'error');
        }
    } catch (e) {
        showToast(`생성 오류: ${e.message}`, 'error');
    }

    btn.disabled = false;
    spinner.classList.add('hidden');
}

async function generateWithSelectedHook() {
    if (!selectedHookText) return;
    await generateWithHook();
}

function agentWithSelectedHook() {
    if (!selectedHookText) return;
    // Close hook lab panel and show instructions panel
    document.getElementById('hook-lab-panel').classList.add('hidden');
    showAgentInstructionsPanel();
}

// --- Hook Card: Copy & Edit ---

function copyHookText(idx, btnEl) {
    const text = generatedHooks[idx].hook;
    navigator.clipboard.writeText(text).then(() => {
        const originalText = btnEl.textContent;
        btnEl.textContent = 'Copied!';
        btnEl.classList.add('bg-green-100', 'text-green-700');
        btnEl.classList.remove('bg-gray-100', 'text-gray-600');
        setTimeout(() => {
            btnEl.textContent = originalText;
            btnEl.classList.remove('bg-green-100', 'text-green-700');
            btnEl.classList.add('bg-gray-100', 'text-gray-600');
        }, 1500);
    });
}

function startHookEdit(idx) {
    const displayEl = document.getElementById(`hook-display-${idx}`);
    const editEl = document.getElementById(`hook-edit-${idx}`);
    const textarea = document.getElementById(`hook-edit-textarea-${idx}`);

    displayEl.classList.add('hidden');
    editEl.classList.remove('hidden');
    textarea.value = generatedHooks[idx].hook;
    updateHookEditCharCount(idx);
    textarea.focus();
}

function cancelHookEdit(idx) {
    document.getElementById(`hook-display-${idx}`).classList.remove('hidden');
    document.getElementById(`hook-edit-${idx}`).classList.add('hidden');
}

function saveHookEdit(idx) {
    const textarea = document.getElementById(`hook-edit-textarea-${idx}`);
    const newText = textarea.value.trim();
    if (!newText) return;

    // Update the hook data
    generatedHooks[idx].hook = newText;

    // Update display
    const displayEl = document.getElementById(`hook-display-${idx}`);
    const preview = renderLinkedInPreview(newText);
    displayEl.querySelector('.hook-preview').innerHTML = preview;

    // Update char count in header
    const charEl = document.getElementById(`hook-char-${idx}`);
    if (charEl) charEl.textContent = `${newText.length}자`;

    // If this hook is currently selected, update selectedHookText
    if (document.getElementById(`hook-card-${idx}`).classList.contains('selected')) {
        selectedHookText = newText;
    }

    // Switch back to display mode
    displayEl.classList.remove('hidden');
    document.getElementById(`hook-edit-${idx}`).classList.add('hidden');

    showToast('훅이 수정되었습니다', 'success');
}

function updateHookEditCharCount(idx) {
    const textarea = document.getElementById(`hook-edit-textarea-${idx}`);
    const counter = document.getElementById(`hook-edit-counter-${idx}`);
    counter.textContent = `${textarea.value.length}자`;
}

// --- Custom Hook Input ---

function onCustomHookInput() {
    const textarea = document.getElementById('hook-custom-textarea');
    const counter = document.getElementById('hook-custom-counter');
    const len = textarea.value.length;
    counter.textContent = `${len}자`;

    if (len > 0) {
        activateCustomHook();
    } else {
        deactivateCustomHook();
        document.getElementById('hook-actions').classList.add('hidden');
    }
}

function activateCustomHook() {
    const textarea = document.getElementById('hook-custom-textarea');
    const text = textarea.value.trim();
    if (!text) return;

    // Deselect all hook cards (mutual exclusivity)
    document.querySelectorAll('.hook-card').forEach(c => c.classList.remove('selected'));

    // Highlight custom card
    const customCard = document.getElementById('hook-custom-card');
    customCard.classList.remove('border-gray-300');
    customCard.classList.add('border-amber-400', 'bg-amber-50');

    // Set selected hook text
    selectedHookText = text;

    // Show actions bar with "직접 입력" label
    const actions = document.getElementById('hook-actions');
    actions.classList.remove('hidden');
    document.getElementById('hook-selected-style').textContent = '직접 입력';
}

function deactivateCustomHook() {
    const customCard = document.getElementById('hook-custom-card');
    if (customCard) {
        customCard.classList.remove('border-amber-400', 'bg-amber-50');
        customCard.classList.add('border-gray-300');
    }
}

// Keyboard shortcuts for article detail page
document.addEventListener('keydown', function(e) {
    // Skip if in input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    switch(e.key) {
        case 'Escape':
            // Close editor if open
            if (!document.getElementById('agent-editor-panel').classList.contains('hidden')) {
                cancelAgentEditor();
            }
            // Close agent workspace if open, else go back
            else if (!document.getElementById('agent-workspace').classList.contains('hidden')) {
                closeAgentWorkspace();
            } else {
                window.location.href = '/articles';
            }
            break;
        case 's':
            e.preventDefault();
            toggleFavorite();
            break;
        case 'g':
            e.preventDefault();
            document.getElementById('generate-btn')?.click();
            break;
        case 'a':
            e.preventDefault();
            if (!document.getElementById('agent-btn').disabled) {
                startAgentMode();
            }
            break;
        case 'h':
            e.preventDefault();
            if (!document.getElementById('hook-lab-btn').disabled) {
                startHookLab();
            }
            break;
        case 'c':
            e.preventDefault();
            if (document.getElementById('compare-btn')) {
                toggleCompareMode();
            }
            break;
    }
});
</script>
{% endblock %}
